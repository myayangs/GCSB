# üõ†Ô∏è GSP1226 - Build an LLM and RAG-based Chat Application using AlloyDB and LangChain

This guide walks you through setting up AlloyDB, initializing a database with the `vector` extension, configuring a retrieval service, and deploying it to Cloud Run with Identity-Aware Proxy (IAP) integration.

---

## üñ•Ô∏è Terminal 1 - Database Setup & Retrieval Service Deployment

```bash
export ZONE=$(gcloud compute instances list --format="value(zone)" --limit=1)

gcloud compute ssh instance-1 --zone="$ZONE" --quiet
```

Use the following command to connect to the VM instance. This step opens an SSH session into the VM.

```bash
export PROJECT_ID=$(gcloud config get-value project)
export REGION=$(gcloud compute instances list \
  --project=$PROJECT_ID \
  --format="value(zone)" \
  --limit=1 | cut -d- -f1-2)

export PGPASSWORD=alloydbworkshop2023
export ADBCLUSTER=alloydb-aip-01
export INSTANCE_IP=$(gcloud alloydb instances describe $ADBCLUSTER-pr \
  --cluster=$ADBCLUSTER \
  --region=$REGION \
  --format="value(ipAddress)")

sudo apt-get update -qq 
sudo apt-get install -y -qq postgresql-client git 

task1() {
  psql "host=$INSTANCE_IP user=postgres" -c "CREATE DATABASE assistantdemo"
  psql "host=$INSTANCE_IP user=postgres dbname=assistantdemo" -c "CREATE EXTENSION vector"
}

task2(){

git clone https://github.com/GoogleCloudPlatform/genai-databases-retrieval-app.git 

cd ~/genai-databases-retrieval-app
gcloud alpha run deploy retrieval-service \
    --source=./retrieval_service/ \
    --no-allow-unauthenticated \
    --service-account retrieval-identity \
    --region $REGION \
    --network=default \
    --quiet
}

task1 &
task2
```

---

## üñ•Ô∏è Terminal 2 - Service Account & IAP OAuth Setup

```bash

export PROJECT_ID=$(gcloud config get-value project)
export ACCOUNT=$(gcloud config get-value account)

sa(){
  gcloud iam service-accounts create retrieval-identity --project $PROJECT_ID
  gcloud projects add-iam-policy-binding $PROJECT_ID \
      --member="serviceAccount:retrieval-identity@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/aiplatform.user"
}

clients(){

gcloud services enable iap.googleapis.com --project $PROJECT_ID

until gcloud iap oauth-brands create \
    --application_title="Web client 1" \
    --support_email=$ACCOUNT \
    --project=$PROJECT_ID; do
  echo "Waiting for brand creation..."
  sleep 2
done

until export BRAND_NAME=$(gcloud iap oauth-brands list \
    --project=$PROJECT_ID \
    --format="value(name)") && [ -n "$BRAND_NAME" ]; do
  echo "Waiting for brand to be created..."
  sleep 2
done

until gcloud iap oauth-clients create $BRAND_NAME \
    --display_name="Web client 1" \
    --project=$PROJECT_ID; do
  echo "Waiting for brand to be ready..."
  sleep 2
done

}

sa &
clients &
```
